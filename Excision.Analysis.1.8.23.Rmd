---
title: "ExcisionAnalysis.1.8.23"
output: html_document
date: "2024-01-08"
---

Libraries:
```{r}
library(hms)
library(patchwork)
library(cowplot)
library(car)
library(ggplot2)
library(ggpubr)
library(emmeans)
library(lubridate)
library(lme4)
library(lmerTest)
library(broom)
library(rstatix)
library(grid)
library(gridExtra)
library(tidyr)
library(writexl)
library(stargazer)
library(margins)
library(sjPlot)
library(fastDummies)
library(webuse)
library(ggeffects)
library(tidyverse)
library(openxlsx)
library(rstatix)
library(kableExtra)
library(FactoMineR)
library(vcd)
library(factoextra)
library(ggpattern)
library(multcomp)
library(maps)
library(ggmap)
library(raster)
library(sp)
library(geodata)
library(terra)
```

**First read in the two R scripts: Read.and.Modify.Data and Create.Delta.Data**

--------------------------------------------------------------------------------
**Oak Section of Methods Figure:** Figure 1
--------------------------------------------------------------------------------
Oak Panels:
```{r}
(qg.dat= full.exin.data%>%
   filter(species=="Q. garryana")%>%
   group_by(Ex.int, obs,time) %>%
  summarize(A_avg = mean(as.numeric(A))))
(qg.plot1=qg.dat%>%
  ggplot(aes(x =time, y=A_avg,color = Ex.int, group=Ex.int)) +    geom_line()+geom_point()+
   theme_bw()+ scale_color_manual(values=c("dodgerblue1", "deeppink4"),name="")+
    xlab("Time of day (hours)")+ylab(expression('Net photosynthetic rate (μmol m'^-2*'s'^-1*')'))+labs(color=NULL, title="Quercus garryana")+
    geom_errorbar(aes(
      ymin = A_avg - ifelse(Ex.int == "Intact", 1.27177, 1.866506),
      ymax = A_avg + ifelse(Ex.int == "Intact", 1.27177, 1.866506)),width = 0.2)+
   theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=15),axis.title.x=element_text(size=15),axis.title.y=element_text(size=15),legend.text = element_text(size = 15), plot.title = element_text(face="italic"))+
     theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          axis.line = element_line(color = "black"),panel.border = element_blank(),axis.text.x = element_text(angle = 45, hjust = 1)))

(wqg.dat= full.exin.data%>%
   filter(species=="Q. garryana")%>%
   group_by(Ex.int, obs,time) %>%
  summarize(mpa_avg = mean(calc.wp)))

(wqg.plot1=wqg.dat%>%
  ggplot(aes(x =time, y=mpa_avg,color = Ex.int, group=Ex.int)) +    geom_line()+geom_point()+
   theme_bw()+ scale_color_manual(values=c("dodgerblue1", "deeppink4"),name="")+
    geom_errorbar(aes(
      ymin = mpa_avg - ifelse(Ex.int == "Intact", 0.2014454, 0.06166861), 
      ymax = mpa_avg + ifelse(Ex.int == "Intact", 0.2014454, 0.06166861)),width = 0.2)+
    xlab("Time of day (hours)")+ylab("Water potential (MPa)")+labs(color=NULL)+
    theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=15),axis.title.x=element_text(size=15),axis.title.y=element_text(size=15),legend.text = element_text(size = 15))+
     theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          axis.line = element_line(color = "black"),panel.border = element_blank(),axis.text.x = element_text(angle = 45, hjust = 1)))

(gqg.dat= full.exin.data%>%
   filter(species=="Q. garryana")%>%
   group_by(Ex.int, obs, time) %>%
  summarize(g_avg = mean(as.numeric(gsw))))

(gqg.plot1=gqg.dat%>%
  ggplot(aes(x =time, y=g_avg,color = Ex.int, group=Ex.int)) +    geom_line()+geom_point()+
   theme_bw()+ scale_color_manual(values=c("dodgerblue1", "deeppink4"),name="")+
    xlab("Time of day (hours)")+ylab(expression('Stomatal conductance (mol m'^-2*'s'^-1*')'))+
    geom_errorbar(aes(
      ymin = g_avg - ifelse(Ex.int == "Intact", 0.01302309, 0.0181749),
      ymax = g_avg + ifelse(Ex.int == "Intact", 0.01302309, 0.0181749)),width = 0.2)+
    theme(axis.text.x=element_text(size=12),axis.text.y=element_text(size=15),axis.title.x=element_text(size=15),axis.title.y=element_text(size=15),legend.text = element_text(size = 15))+
     theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          axis.line = element_line(color = "black"),panel.border = element_blank(),axis.text.x = element_text(angle = 45, hjust = 1)))

(qg.time=ggarrange(qg.plot1,wqg.plot1,gqg.plot1,ncol=3,nrow=1,labels=c("H","I","J"), common.legend=TRUE,label.x = 0.11))
```

--------------------------------------------------------------------------------
**Overall Water Potential Figure:** Figure 2
--------------------------------------------------------------------------------
```{r}
full.exin.data$obs=as.character(full.exin.data$obs)
full.exin.data$elapsed = as.numeric(full.exin.data$elapsed)

test.intact = full.exin.data%>%
  filter(Ex.int =="Intact")
watpot.lm.int=lm(calc.wp~elapsed,data=test.intact)
(summary(watpot.lm.int)) #Time is super significant!

test.ex = full.exin.data%>%
  filter(Ex.int =="Excised")
watpot.lm.ex=lm(calc.wp~elapsed,data=full.exin.data)
(summary(watpot.lm.ex)) #Time is not significant

A.watpot.lm.dat=full.exin.data%>%
  filter(Ex.int=="Intact")
A.watpot.lm=lm(A~calc.wp,data=A.watpot.lm.dat)
(summary(A.watpot.lm)) #Water potential is actually a good predictor of intact A...

wat.mean.ex <- full.exin.data %>%
  filter(Ex.int == "Excised") %>%
  group_by(obs) %>%
  summarize(
    mean_Water.pot = mean(calc.wp),
    SE_wat.pot = sd(calc.wp) / sqrt(n()))

wat.mean.int <- full.exin.data %>%
  filter(Ex.int == "Intact") %>%
  group_by(obs) %>%
  summarize(
    mean_Water.pot = mean(calc.wp),
    SE_wat.pot = sd(calc.wp) / sqrt(n()))

wat.mean.ex$Set <- "Excised"
wat.mean.int$Set <- "Intact"
(wat.df <- bind_rows(wat.mean.ex, wat.mean.int))

wat.df = wat.df%>%mutate(time=case_when(
    obs=="1" ~ "08:30",obs=="2" ~ "08:30",
    obs=="3" ~ "09:30",obs=="4" ~ "09:30",
    obs=="5" ~ "10:30",obs=="6" ~ "10:30",
    obs=="7" ~ "11:30",obs=="8" ~ "11:30",
    obs=="9" ~ "12:30",obs=="10" ~ "12:30",
    obs=="11" ~ "13:30",obs=="12" ~ "13:30",
    obs=="13" ~ "14:30",obs=="14" ~ "14:30",
    obs=="15" ~ "15:30",obs=="16" ~ "15:30"))

(watpotplot=wat.df%>%
  ggplot(aes(x =time, y=mean_Water.pot,color = Set, group=Set)) +    geom_line()+geom_point()+
   theme_bw()+ scale_color_manual(values=c("dodgerblue1", "deeppink4"),name="")+
    geom_errorbar(aes(
      ymin = mean_Water.pot - SE_wat.pot,
      ymax = mean_Water.pot + SE_wat.pot),width = 0.2)+
    xlab("Time of day (hours)")+ylab("Water potential (MPa)")+
     theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          axis.line = element_line(color = "black"),panel.border = element_blank()))

(watpotplot.reg = wat.df %>%
  ggplot(aes(x = time, y = mean_Water.pot, color = Set, group = Set)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, aes(group = Set, color = Set, fill = Set)) + # Set color and fill aesthetics
  theme_bw() +
  scale_color_manual(values = c("dodgerblue1", "deeppink4"), name = "") +
  scale_fill_manual(values = c("dodgerblue1", "deeppink4"), name = "") + # Set fill colors for the bands
  xlab("Time of day (hours)") +
  ylab("Water potential (MPa)") +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_blank()
  )
)
```

--------------------------------------------------------------------------------
**Aint vs. Aex Plots:** Figure 3
--------------------------------------------------------------------------------
Graph Aint vs. Aex and color by species - show 1:1 line
```{r}
(Aint.vs.Aex = full.exin.delta %>%
  filter(A.ex > 0) %>%
  filter(A.int > 0) %>%
  ggscatter(x = "A.int", y = "A.ex", color = "species", add = "reg.line", conf.int = TRUE) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 15), axis.text.y = element_text(size = 15), legend.text = element_text(face = "italic")) +
  xlab(expression('Intact photosynthesis (μmol m'^-2*'s'^-1*')')) +
  ylab(expression('Excised photosynthesis (μmol m'^-2*'s'^-1*')')) +
  geom_abline(slope = 1, linetype = "dashed") +
  xlim(0, 20) +
  ylim(0, 20) +
  scale_color_manual(values = c("#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#66A61E"), labels = c("Acer campestre", "Betula papyrifera", "Carpinus betulus", "Pseudotsuga menziesii", "Quercus garryana")) +
  scale_fill_manual(values = c("#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#66A61E"), labels = c("Acer campestre", "Betula papyrifera", "Carpinus betulus", "Pseudotsuga menziesii", "Quercus garryana"))
)

(gint.vs.gex = full.exin.delta %>%
  ggscatter(x = "gs.int", y = "gs.ex", color = "species", add = "reg.line", conf.int = TRUE) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 15), axis.text.y = element_text(size = 15), legend.text = element_text(face = "italic")) +
  xlab(expression('Intact stomatal conductance (mol m'^-2*'s'^-1*')')) +
  ylab(expression('Excised stomatal conductance (mol m'^-2*'s'^-1*')')) +
  geom_abline(slope = 1, linetype = "dashed") +
  xlim(0, 0.25) +
  ylim(0, 0.25) +
  scale_color_manual(values = c("#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#66A61E"), labels = c("Acer campestre", "Betula papyrifera", "Carpinus betulus", "Pseudotsuga menziesii", "Quercus garryana")) +
  scale_fill_manual(values = c("#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#66A61E"), labels = c("Acer campestre", "Betula papyrifera", "Carpinus betulus", "Pseudotsuga menziesii", "Quercus garryana"))
)

(wpint.vs.wpex = full.exin.delta %>%
  ggscatter(x = "watpot.int.mpa", y = "watpot.ex.mpa", color = "species", add = "reg.line", conf.int = TRUE) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 15), axis.text.y = element_text(size = 15), legend.text = element_text(face = "italic")) +
  xlab(expression('Intact water potential (MPa)')) +
  ylab(expression('Excised water potential (MPa)')) +
  geom_abline(slope = 1, linetype = "dashed") +
  xlim(-4, 0) +
  ylim(-4, 0) +
  scale_color_manual(values = c("#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#66A61E"), labels = c("Acer campestre", "Betula papyrifera", "Carpinus betulus", "Pseudotsuga menziesii", "Quercus garryana")) +
  scale_fill_manual(values = c("#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#66A61E"), labels = c("Acer campestre", "Betula papyrifera", "Carpinus betulus", "Pseudotsuga menziesii", "Quercus garryana"))
)

(ex.int.arranged = ggarrange(wpint.vs.wpex, gint.vs.gex, Aint.vs.Aex, nrow = 1, ncol = 3, labels = c("A", "B", "C"), common.legend = TRUE))

```

--------------------------------------------------------------------------------
**Mixed Effects Model and Plots:** Figure 4
--------------------------------------------------------------------------------
Run Linear mixed effects model:
  Fixed effects: everything else
  Random effects: individual with branch nested within
  
Main species mixed-effects model:
```{r}
#best to exclude time because it is circular and DOY since this is to related to individual.
#Need to nest branch random effect within individual random effect.
full.exin.data$A = as.numeric(full.exin.data$A)
full.exin.data$Measure.height = as.numeric(full.exin.data$Measure.height)
full.exin.data$Air.temp = as.numeric(full.exin.data$Air.temp)
full.exin.data$Water.pot = as.numeric(full.exin.data$Water.pot)
full.exin.data$gsw = as.numeric(full.exin.data$gsw)
full.exin.data$calc.wp = as.numeric(full.exin.data$calc.wp)

mixed2.modA <- lmer(A ~ (1|individual/branch) +Water.pot+ Measure.height+Air.temp+ Ex.int*species, data = full.exin.data)
(summary2_tableA <- summary(mixed2.modA))

mixed.modg <- lmer(gsw ~ (1|individual/branch) +Water.pot+ Air.temp+ Measure.height+ Ex.int*species, data = full.exin.data)
(summary_tableg <- summary(mixed.modg))

mixed.modwatpot <- lmer(calc.wp ~ (1|individual/branch) +gsw+ Air.temp+ Measure.height+ Ex.int*species, data = full.exin.data)
(summary_tablewatpot <- summary(mixed.modwatpot))
```  

Species ~ A effect size plot:
```{r}
(fixed_effects_p_values.A <- summary2_tableA$coefficients[, "Pr(>|t|)"])
(contrasts <- emmeans(mixed2.modA, pairwise ~ Ex.int | species))

# Create a data frame with the provided contrast results
contrast_data.A <- data.frame(
  species = c("Acer campestre", "Betula papyrifera", "Carpinus betulus", "Pseudotsuga menziesii", "Quercus garryana"),
  estimate = c(-2.922,  -0.550, -0.806, 1.658, -6.473),
  significant = c(TRUE, FALSE, FALSE, TRUE, TRUE),
  SE=c(0.580,0.576,0.588,0.522,0.690))

(species.A<-ggplot(contrast_data.A, aes(x = species, y = estimate, fill = species, shape = species)) +
  geom_point(position = position_dodge(width = 0.75), size = 3) +
  geom_errorbar(
    aes(ymin = estimate - SE, ymax = estimate + SE),
    width = 0,
    position = position_dodge(width = 0.75)) +
  theme_classic() +
  theme(axis.text.y = element_text(face="italic"),axis.text.x = element_text(size = 12),axis.title.x = element_text(size = 10),axis.title.y = element_text(size = 15),legend.title= element_blank(),legend.text = element_text(face = "italic")) +
  ylab("Effect size for photosynthesis") + xlab(" ") +  
  scale_shape_manual(values = c(25,23,22,24,21), labels = c("Acer campestre", "Betula papyrifera", "Carpinus betulus", "Pseudotsuga menziesii", "Quercus garryana")) +
  scale_fill_manual(values = c("#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E"),labels = c("Acer campestre", "Betula papyrifera", "Carpinus betulus", "Pseudotsuga menziesii", "Quercus garryana")) +
    geom_hline(yintercept=0, linetype="dashed")+
  labs(fill = "species", shape = "species") +
  coord_flip())

(species.A.plot=species.A + geom_text(aes(label = ifelse(significant, "*", "")), size = 6, vjust = 0, hjust = 0))
```
Species ~ gsw effect size plot:
```{r}
(fixed_effects_p_values.g <- summary_tableg$coefficients[, "Pr(>|t|)"])
(contrasts <- emmeans(mixed.modg, pairwise ~ Ex.int | species))

# Create a data frame with the provided contrast results
contrast_data.g <- data.frame(
  species = c("Acer campestre", "Betula papyrifera", "Carpinus betulus", "Pseudotsuga menziesii", "Quercus garryana"),
  estimate = c(-0.02615, -0.00928, -0.01578, 0.00957, -0.05427),
  significant = c(TRUE, FALSE, TRUE, TRUE, TRUE),
  SE=c(0.00504,0.00501,0.00512,0.00448,0.00610))

(species.g=(ggplot(contrast_data.g, aes(x = species, y = estimate, fill = species, shape = species)) +
  geom_point(position = position_dodge(width = 0.75), size = 3) +
  geom_errorbar(
    aes(ymin = estimate - SE, ymax = estimate + SE),
    width = 0,
    position = position_dodge(width = 0.75)
  ) +
  theme_classic() +
  theme(axis.text.y = element_text(face="italic"),axis.text.x = element_text(size = 12),axis.title.x = element_text(size = 9),axis.title.y = element_text(size = 15),legend.title= element_blank(),legend.text = element_text(face = "italic")) +
  ylab(expression('Effect size for stomatal conductance')) +  
  xlab(" ") + 
  scale_shape_manual(values = c(25,23,22,24,21),labels = c("Acer campestre", "Betula papyrifera", "Carpinus betulus", "Pseudotsuga menziesii", "Quercus garryana")) +
  scale_fill_manual(values = c("#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E"),labels = c("Acer campestre", "Betula papyrifera", "Carpinus betulus", "Pseudotsuga menziesii", "Quercus garryana")) +
    geom_hline(yintercept=0, linetype="dashed")+
  labs(fill = "species", shape = "species") +
  coord_flip()))  # Flip the coordinates to make species vertical

(species.g.plot=species.g + geom_text(aes(label = ifelse(significant, "*", "")), size = 6, vjust = 0, hjust = 0))
```
Species ~ Watpot effect size plot:
```{r}
(fixed_effects_p_values.watpot <- summary_tablewatpot$coefficients[, "Pr(>|t|)"])
(contrasts <- emmeans(mixed.modwatpot, pairwise ~ Ex.int | species))

# Create a data frame with the provided contrast results
contrast_data.watpot <- data.frame(
  species = c("Acer campestre", "Betula papyrifera", "Carpinus betulus", "Pseudotsuga menziesii", "Quercus garryana"),
  estimate = c(0.806,  0.794,0.849, 0.479, 1.260),
  significant = c(TRUE, TRUE,TRUE, TRUE, TRUE),
  SE=c(0.0698,0.0676,0.0682,0.0675,0.0778))

(species.watpot=(ggplot(contrast_data.watpot, aes(x = species, y = estimate, fill = species, shape = species)) +
  geom_point(position = position_dodge(width = 0.75), size = 3) +
  geom_errorbar(aes(ymin = estimate - SE, ymax = estimate + SE),width = 0,position = position_dodge(width = 0.75)) +
  theme_classic() +
  theme(axis.text.y = element_text(size = 12, face="italic"),axis.text.x = element_text(size = 12),axis.title.x = element_text(size = 10),axis.title.y = element_text(size = 15),legend.title= element_blank(),legend.text = element_text(face = "italic")) +
  ylab("Effect size for water potential") + 
  xlab(" ") +
  scale_shape_manual(values = c(25,23,22,24,21),labels = c("Acer campestre", "Betula papyrifera", "Carpinus betulus", "Pseudotsuga menziesii", "Quercus garryana")) +
  scale_fill_manual(values = c("#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E"),labels = c("Acer campestre", "Betula papyrifera", "Carpinus betulus", "Pseudotsuga menziesii", "Quercus garryana")) +
    geom_hline(yintercept=0, linetype="dashed")+
  labs(fill = "species", shape = "species") +
  coord_flip()))

(species.watpot.plot=species.watpot + geom_text(aes(label = ifelse(significant, "*", "")), size = 6, vjust = 0, hjust = 0))
```

Combine into a species effect plot based on the mixed effects models:
```{r}
(species.arranged=ggarrange(species.watpot.plot,species.g.plot,species.A.plot,nrow=1,ncol=3,labels=c("A","B","C"),common.legend=TRUE,widths = c(1.5, 1, 1)))
```

--------------------------------------------------------------------------------
**Kar and Medlyn Plots:** Figure 5
--------------------------------------------------------------------------------
Medlyn 2011
```{r}
full.exin.data$VPDleaf = as.numeric(full.exin.data$VPDleaf)
full.exin.data$Ca = as.numeric(full.exin.data$Ca)

full.exin.data=full.exin.data%>%
  mutate(carvpd=(1.6*A/(Ca/sqrt(VPDleaf))))

F=as.formula(y~x)
(medlyn.fig.int= full.exin.data%>%
    filter(carvpd>0)%>%
    filter(Ex.int=="Intact")%>%
  ggplot(aes(x =carvpd, y=gsw, color=species)) + geom_point(shape=18)+
   theme_classic()+theme(axis.text.x=element_text(size=15))+
    xlab(expression(1.6*A/(Ca*sqrt(VPD))))+ylab(expression('Stomatal conductance (mol / (m'^2*'s)'*''))+
    stat_smooth(aes(fill=species,color=species),method="lm",formula=F)+
    stat_regline_equation(label.x=c(0.006,0.006,0.006,0.006,0.006),label.y=c(0.225 ,0.208,0.192,0.175,0.16),aes(label =  paste(..eq.label.., sep = "~~~~")),formula=F,size=4)+
    #stat_cor(aes(color=species,label = paste(..p.label..)), label.x = c(0,0,0,0,0), #if you put this back in, change the label.x from prev pit to 0.023
             #label.y =c(0.225 ,0.208,0.192,0.175,0.16))+
    theme(legend.position = "none")+
  scale_color_brewer(palette="Dark2",labels = c("Quercus garryana", "Pseudotsuga menziesii", "Carpinus betulus", "Betula papyrifera", "Acer campestre"))+scale_fill_brewer(palette="Dark2",labels = c("Quercus garryana", "Pseudotsuga menziesii", "Carpinus betulus", "Betula papyrifera", "Acer campestre")))

(medlyn.fig.ex= full.exin.data%>%
    filter(carvpd>0)%>%
    filter(Ex.int=="Excised")%>%
  ggplot(aes(x =carvpd, y=gsw, color=species)) + geom_point(shape=16)+
   theme_classic()+theme(axis.text.x=element_text(size=15))+
    xlab(expression(1.6*A/(Ca*sqrt(VPD))))+ylab(expression('Stomatal conductance (mol / (m'^2*'s)'*''))+
    stat_smooth(aes(fill=species,color=species),method="lm",formula=F)+
    stat_regline_equation(label.x=c(0.006,0.006,0.006,0.006,0.006),label.y=c(0.225 ,0.208,0.192,0.175,0.16),aes(label =  paste(..eq.label..)),formula=F,size=4)+
    theme(legend.position = "none")+
    #stat_cor(aes(color=species,label = paste(..p.label..)), label.x = c(0,0,0,0,0),  #if you comment this back in, put the label.x for the previous bit as 0.018
             #label.y =c(0.225 ,0.208,0.192,0.175,0.16))+
  scale_color_brewer(palette="Dark2",labels = c("Quercus garryana", "Pseudotsuga menziesii", "Carpinus betulus", "Betula papyrifera", "Acer campestre"))+scale_fill_brewer(palette="Dark2",labels = c("Quercus garryana", "Pseudotsuga menziesii", "Carpinus betulus", "Betula papyrifera", "Acer campestre")))
```
g1 graph - medlyn 2011
```{r}
# Calculate the slopes, standard errors, and set Ex.int for Intact
slopes.int <- full.exin.data %>%
  filter(carvpd > 0) %>%
  filter(Ex.int == "Intact") %>%
  group_by(species) %>%
  do({
    model <- lm(gsw ~ carvpd, data = .)
    slope <- coef(model)[[2]]
    se_slope <- summary(model)$coefficients[2, "Std. Error"]
    ex.int <- "Intact"
    data.frame(slope = slope, se_slope = se_slope, ex.int = ex.int)
  })

# Calculate the slopes, standard errors, and set Ex.int for Excised
slopes.ex <- full.exin.data %>%
  filter(carvpd > 0) %>%
  filter(Ex.int == "Excised") %>%
  group_by(species) %>%
  do({
    model <- lm(gsw ~ carvpd, data = .)
    slope <- coef(model)[[2]]
    se_slope <- summary(model)$coefficients[2, "Std. Error"]
    ex.int <- "Excised"
    data.frame(slope = slope, se_slope = se_slope, ex.int = ex.int)
  })
combined_data = bind_rows(slopes.int,slopes.ex)

# Plot the graph with different colors and shapes for Intact and Excised, and species on the vertical axis
(g1.plot=(ggplot(combined_data, aes(x = species, y = slope, shape = ex.int, fill=species)) +
  geom_point(position = position_dodge(width = 0.75), size = 3) +
  geom_errorbar(aes(ymin = slope - se_slope, ymax = slope + se_slope),width = 0,
    position = position_dodge(width = 0.75)) +
  theme_classic() +theme(axis.text.y = element_text(size = 12, face="italic"),axis.text.x = element_text(size = 12),axis.title.x = element_text(size = 12),
                         axis.title.y = element_text(size = 15),legend.title= element_blank(), legend.text = element_text(face="italic")) +
  ylab(expression('g'[1])) + xlab(" ") +
  scale_shape_manual(values = c(21,23)) +
  scale_fill_manual(values = c("#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#66A61E"),
                    labels = c("Quercus garryana", "Pseudotsuga menziesii", "Carpinus betulus", "Betula papyrifera", "Acer campestre")) +
  labs(fill = "species",shape = "Ex.int") +
  coord_flip()+guides(fill = guide_legend(override.aes = list(shape = c(22,22,22,22,22))))))


```

Combine Plots:
```{r}
med.2=ggarrange(medlyn.fig.int,medlyn.fig.ex,labels=c("A","B"))
(medlyn.fig=ggarrange(med.2,g1.plot,widths=c(1.5,1),labels=c("","C")))
```

Compare slopes: Conclusion: only the pm is significant.
```{r}
ac.lm.dat <- full.exin.data%>%
  filter(species=="A. campestre")
bp.lm.dat <- full.exin.data%>%
  filter(species=="B. papyrifera")
cb.lm.dat <- full.exin.data%>%
  filter(species=="C. betulus")
pm.lm.dat <- full.exin.data%>%
  filter(species=="P. menziesii")
qg.lm.dat <- full.exin.data%>%
  filter(species=="Q. garryana")
  
ac.inter=aov(gsw ~ carvpd * Ex.int, data = ac.lm.dat)
bp.inter=aov(gsw ~ carvpd * Ex.int, data = bp.lm.dat)
cb.inter=aov(gsw ~ carvpd * Ex.int, data = cb.lm.dat)
pm.inter=aov(gsw ~ carvpd * Ex.int, data = pm.lm.dat)
qg.inter=aov(gsw ~ carvpd * Ex.int, data = qg.lm.dat)

ac.noint=aov(gsw ~ carvpd + Ex.int, data = ac.lm.dat)
bp.noint=aov(gsw ~ carvpd + Ex.int, data = bp.lm.dat)
cb.noint=aov(gsw ~ carvpd + Ex.int, data = cb.lm.dat)
pm.noint=aov(gsw ~ carvpd + Ex.int, data = pm.lm.dat)
qg.noint=aov(gsw ~ carvpd + Ex.int, data = qg.lm.dat)

anova(ac.inter,ac.noint) #not sig
anova(bp.inter,bp.noint) #not sig
anova(cb.inter,cb.noint) #not sig
anova(pm.inter,pm.noint) #significant
anova(qg.inter,qg.noint) #not sig
```

PSI Net dataset prep:
```{r}
#psi.net.set = full.exin.data%>%
  #select(species,individ,individual,calc.wp,hhmmss...5,date,Air.temp,Ex.int,obs,Measure.height,A,gsw,VPDleaf)
#write.xlsx(psi.net.set, "psi.net.set.xlsx")

```

Meta-analysis figure:
```{r}

# Load Data
RRDat <- read.xlsx("ExtraFiles/logRR_ExcisionData.xlsx")

# Function to calculate lnRR based on Eqn 4 of Nakagawa et al. 2022
calculate_lnRR <- function(df) {
  df <- df %>%
    mutate(across(c(AmeanEx, AmeanInt, Aex_SE, Aint_SE, gEx, gInt, gExSE, gIntSE, n), as.numeric)) %>%
    mutate(
      lnRRr = ifelse(is.na(Aex_SE), NA, log(AmeanEx / AmeanInt) + 0.5 * ((Aex_SE^2 / n) - (Aint_SE^2 / n))),
      lnRR = log(AmeanEx / AmeanInt),
      SE_lnRR = ifelse(is.na(Aex_SE), NA, sqrt((Aex_SE / (n * AmeanEx^2)) + (Aint_SE / (n * AmeanInt^2)))),
      glnRRr = ifelse(is.na(gExSE) | is.na(gEx), NA, log(gEx / gInt) + 0.5 * ((gExSE^2 / n) - (gIntSE^2 / n))),
      glnRR = ifelse(is.na(gEx), NA, log(gEx / gInt)),
      gSE_lnRR = ifelse(is.na(gExSE) | is.na(gEx), NA, sqrt((gExSE / (n * gEx^2)) + (gIntSE / (n * gInt^2))))
    )
  return(df)
}

newRRDat <- calculate_lnRR(RRDat)

newRRDat <- newRRDat %>%
  mutate(Species = factor(Species, levels = rev(sort(unique(Species)))))

# Function to create main species panel
create_mainpanel <- function(data, column) {
  data %>%
    group_by(!!sym(column)) %>%
    summarise(
      mean_lnRR = lnRR, na.rm = TRUE,
      mean_glnRR = glnRR, na.rm = TRUE,
      SE_lnRR = SE_lnRR,
      SE_glnRR = gSE_lnRR
    ) %>%
    pivot_longer(cols = c(mean_lnRR, mean_glnRR), names_to = "Response", values_to = "Value") %>%
    ggplot(aes(x = Value, y = !!sym(column), color = Response, shape = Response)) +
    geom_point(size = 3, position = position_dodge(0.9)) +
    geom_errorbarh(aes(xmin = Value - 1.96 * SE_lnRR, xmax = Value + 1.96 * SE_lnRR), position = position_dodge(0.9), height = 0.25) +
    geom_vline(xintercept = 0, linetype = "dotted", color = "black") +
    scale_color_manual(
      values = c("mean_lnRR" = "darkred", "mean_glnRR" = "lightblue"),
      labels = c("mean_lnRR" = "Photosynthesis", "mean_glnRR" = "Stomatal conductance"),
      name = "Response"
    ) +
    scale_shape_manual(
      values = c("mean_lnRR" = 16, "mean_glnRR" = 17),  # Different shapes for lnRR and glnRR
      labels = c("mean_lnRR" = "Photosynthesis", "mean_glnRR" = "Stomatal conductance"),
      name = "Response"
    ) +
    labs(x = "Log Response Ratio", y = " ") +
    theme_classic() +
    theme(
      panel.border = element_rect(color = "black", fill = NA),
      axis.text.y = element_text(face = "italic", size = 16),
      axis.text.x = element_text(size = 16),
      axis.title = element_text(size = 18),
      legend.text = element_text(size = 18),
      legend.title = element_text(size = 18)
    )
}

# Function to create subpanels with independent filtering
create_subpanel <- function(data, column, show_x_title = TRUE) {
  filtered_data <- data %>%
    filter(!is.na(!!sym(column)) & !!sym(column) != "Unknown" & !!sym(column) != "Unclassified")
  plot <- filtered_data %>%
    group_by(!!sym(column)) %>%
    summarise(
      mean_lnRR = mean(lnRR, na.rm = TRUE),
      mean_glnRR = mean(glnRR, na.rm = TRUE),
      SE_lnRR = sd(lnRR, na.rm = TRUE) / sqrt(n()),
      SE_glnRR = sd(glnRR, na.rm = TRUE) / sqrt(n())
    ) %>%
    pivot_longer(cols = c(mean_lnRR, mean_glnRR), names_to = "Response", values_to = "Value") %>%
    ggplot(aes(x = Value, y = !!sym(column), color = Response, shape = Response)) +
    geom_point(size = 3, position = position_dodge(0.9)) +
    geom_errorbarh(aes(xmin = Value - 1.96 * SE_lnRR, xmax = Value + 1.96 * SE_lnRR), 
                   position = position_dodge(0.9), height = 0.25) +
    geom_vline(xintercept = 0, linetype = "dotted", color = "black") +
    scale_color_manual(
      values = c("mean_lnRR" = "darkred", "mean_glnRR" = "lightblue"),
      labels = c("mean_lnRR" = "Photosynthesis", "mean_glnRR" = "Stomatal conductance"),
      name = "Response"
    ) +
    scale_shape_manual(
      values = c("mean_lnRR" = 16, "mean_glnRR" = 17),  # Different shapes for lnRR and glnRR
      labels = c("mean_lnRR" = "Photosynthesis", "mean_glnRR" = "Stomatal conductance"),
      name = "Response"
    ) +
    labs(x = ifelse(show_x_title, "Log Response Ratio", ""), y=" ") +
    theme_classic() +
    theme(
      panel.border = element_rect(color = "black", fill = NA),
      axis.text.y = element_text(size = 16),
      axis.text.x = element_text(size = 16),
      axis.title = element_text(size = 18),
      legend.text = element_text(size = 18),
      legend.title = element_text(size = 18)
    ) +
    scale_x_continuous(limits = c(-3, 2.5))
}

# Create panels
main_panel <- create_mainpanel(newRRDat, "Species")
xylem_panel <- create_subpanel(newRRDat, "Xylem", show_x_title = FALSE)
exudates_panel <- create_subpanel(newRRDat, "Exudates", show_x_title = TRUE)
clade_panel <- create_subpanel(newRRDat, "Clade", show_x_title = FALSE)
drought_strategy_panel <- create_subpanel(newRRDat, "Drought_Strategy", show_x_title = FALSE)

# Combine all plots into one multi-panel plot using patchwork
multi_panel_plot <- (main_panel | ( clade_panel / xylem_panel / drought_strategy_panel / exudates_panel)) + 
  plot_layout(widths = c(3, 2), guides = 'collect') + 
  plot_annotation(tag_levels = 'A', tag_prefix = "", tag_suffix = "", tag_sep = ". ") & 
  theme(legend.position = "bottom", plot.tag = element_text(face = "bold", size = 16))

# Save the plot
ggsave("multi_panel_plot.png", plot = multi_panel_plot, width = 14, height = 10, dpi = 300)

#Calculate n values for each category for figure caption
calculate_n_per_category <- function(data, column) {
  data %>%
    filter(!is.na(!!sym(column)) & !!sym(column) != "Unknown" & !!sym(column) != "Unclassified") %>%
    group_by(!!sym(column)) %>%
    summarise(n = sum(n, na.rm = TRUE)) %>%
    arrange(desc(n))
}

# Calculate n for each category in the subpanels
(n_xylem <- calculate_n_per_category(newRRDat, "Xylem"))
(n_exudates <- calculate_n_per_category(newRRDat, "Exudates"))
(n_clade <- calculate_n_per_category(newRRDat, "Clade"))
(n_drought_strategy <- calculate_n_per_category(newRRDat, "Drought_Strategy"))


# Calculate P-values for log response ratios of categories
filter_data <- function(data, column) {
  data %>%
    filter(!is.na(!!sym(column)) & !!sym(column) != "Unknown" & !!sym(column) != "Unclassified")
}

filtered_data_xylem <- filter_data(newRRDat, "Xylem")
filtered_data_exudates <- filter_data(newRRDat, "Exudates")
filtered_data_clade <- filter_data(newRRDat, "Clade")
filtered_data_drought_strategy <- filter_data(newRRDat, "Drought_Strategy")

# Perform ANOVA for each category
anova_xylem <- aov(lnRR ~ Xylem, data = filtered_data_xylem)
anova_exudates <- aov(lnRR ~ Exudates, data = filtered_data_exudates)
anova_clade <- aov(lnRR ~ Clade, data = filtered_data_clade)
anova_drought_strategy <- aov(lnRR ~ Drought_Strategy, data = filtered_data_drought_strategy)

# Summary of ANOVA results
summary(anova_xylem)
(tukey_xylem <- TukeyHSD(anova_xylem))
summary(anova_exudates)
(tukey_exud <- TukeyHSD(anova_exudates))
summary(anova_clade)
(tukey_clade <- TukeyHSD(anova_clade))
summary(anova_drought_strategy)
(tukey_ds <- TukeyHSD(anova_drought_strategy))
```

Text reported stats (also section above titled compare slopes:...) 
```{r}
ACDAT <- full.exin.delta%>%
  filter(species=="A. campestre")
BPDAT <- full.exin.delta%>%
  filter(species=="B. papyrifera")
CBDAT <- full.exin.delta%>%
  filter(species=="C. betulus")
PMDAT <- full.exin.delta%>%
  filter(species=="P. menziesii")
QGDAT <- full.exin.delta%>%
  filter(species=="Q. garryana")
summary(lm(A.int~A.ex, data=ACDAT))
summary(lm(gs.int~gs.ex, data=ACDAT))
summary(lm(A.int~A.ex, data=BPDAT))
summary(lm(gs.int~gs.ex, data=BPDAT))
summary(lm(A.int~A.ex, data=CBDAT))
summary(lm(gs.int~gs.ex, data=CBDAT))
summary(lm(A.int~A.ex, data=PMDAT))
summary(lm(gs.int~gs.ex, data=PMDAT))
summary(lm(A.int~A.ex, data=QGDAT))
summary(lm(gs.int~gs.ex, data=QGDAT))

intact.AC <- full.exin.data%>%
  filter(species=="A. campestre")%>%
  filter(Ex.int=="Intact")
Ex.AC <- full.exin.data%>%
  filter(species=="A. campestre")%>%
  filter(Ex.int=="Excised")

intact.BP <- full.exin.data%>%
  filter(species=="B. papyrifera")%>%
  filter(Ex.int=="Intact")
Ex.BP <- full.exin.data%>%
  filter(species=="B. papyrifera")%>%
  filter(Ex.int=="Excised")

intact.CB <- full.exin.data%>%
  filter(species=="C. betulus")%>%
  filter(Ex.int=="Intact")
Ex.CB <- full.exin.data%>%
  filter(species=="C. betulus")%>%
  filter(Ex.int=="Excised")

intact.PM <- full.exin.data%>%
  filter(species=="P. menziesii")%>%
  filter(Ex.int=="Intact")
Ex.PM <- full.exin.data%>%
  filter(species=="P. menziesii")%>%
  filter(Ex.int=="Excised")

intact.QG <- full.exin.data%>%
  filter(species=="Q. garryana")%>%
  filter(Ex.int=="Intact")
Ex.QG <- full.exin.data%>%
  filter(species=="Q. garryana")%>%
  filter(Ex.int=="Excised")


filt.qg.dat <- full.exin.delta%>%filter(species=="Q. garryana")
summary(lm(watpot.ex~watpot.int, data=filt.qg.dat))

filt.pm.dat <- full.exin.delta%>%filter(species=="P. menziesii")
summary(lm(watpot.ex~watpot.int, data=filt.pm.dat))

(percentDecr_AC.A = ((mean(Ex.AC$A) - mean(intact.AC$A)) / mean(intact.AC$A))*100)
(percentDecr_BP.A = ((mean(Ex.BP$A) - mean(intact.BP$A)) / mean(intact.BP$A))*100)
(percentDecr_CB.A = ((mean(Ex.CB$A) - mean(intact.CB$A)) / mean(intact.CB$A))*100)
(percentDecr_PM.A = ((mean(Ex.PM$A) - mean(intact.PM$A)) / mean(intact.PM$A))*100)
(percentDecr_QG.A = ((mean(Ex.QG$A) - mean(intact.QG$A)) / mean(intact.QG$A))*100)

(percentDecr_AC.g = ((mean(Ex.AC$gsw) - mean(intact.AC$gsw)) / mean(intact.AC$gsw))*100)
(percentDecr_BP.g = ((mean(Ex.BP$gsw) - mean(intact.BP$gsw)) / mean(intact.BP$gsw))*100)
(percentDecr_CB.g = ((mean(Ex.CB$gsw) - mean(intact.CB$gsw)) / mean(intact.CB$gsw))*100)
(percentDecr_PM.g = ((mean(Ex.PM$gsw) - mean(intact.PM$gsw)) / mean(intact.PM$gsw))*100)
(percentDecr_QG.g = ((mean(Ex.QG$gsw) - mean(intact.QG$gsw)) / mean(intact.QG$gsw))*100)


ac.dat <- full.exin.delta%>%
  filter(species == "A. campestre")
summary(lm(watpot.int.mpa~watpot.ex.mpa, data=ac.dat))
summary(lm(gs.int~gs.ex, data=ac.dat))
summary(lm(A.int~A.ex, data=ac.dat))

bp.dat <- full.exin.delta%>%
  filter(species == "B. papyrifera")
summary(lm(watpot.int.mpa~watpot.ex.mpa, data=bp.dat))
summary(lm(gs.int~gs.ex, data=bp.dat))
summary(lm(A.int~A.ex, data=bp.dat))

cb.dat <- full.exin.delta%>%
  filter(species == "C. betulus")
summary(lm(watpot.int.mpa~watpot.ex.mpa, data=cb.dat))
summary(lm(gs.int~gs.ex, data=cb.dat))
summary(lm(A.int~A.ex, data=cb.dat))

pm.dat <- full.exin.delta%>%
  filter(species == "P. menziesii")
summary(lm(watpot.int.mpa~watpot.ex.mpa, data=pm.dat))
summary(lm(gs.int~gs.ex, data=pm.dat))
summary(lm(A.int~A.ex, data=pm.dat))
(plot(pm.dat$watpot.ex.mpa, pm.dat$watpot.int.mpa))

qg.dat <- full.exin.delta%>%
  filter(species == "Q. garryana")
summary(lm(watpot.int.mpa~watpot.ex.mpa, data=qg.dat))
summary(lm(gs.int~gs.ex, data=qg.dat))
summary(lm(A.int~A.ex, data=qg.dat))
```

Figure S3:
```{r}
AC.corr.dat <- read.csv("corr.dat/AC.corr.dat_plot.csv")
(plot.AC.corr <- AC.corr.dat %>%
  mutate(indiv = as.factor(indiv)) %>%  # Ensure 'individual' is a factor
  ggplot(aes(x = elapsed/60, y = A, color = indiv, group = indiv)) +  # Add group = individual
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  labs(title = "Acer campestre", x = " ", y = "") + 
  theme_minimal() + 
  scale_color_manual(values = c("#1B9E77", "#1B9E77", "#1B9E77", "#1B9E77", "#1B9E77"), name = "") +
  theme(
    legend.position = "none",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_blank(),
    plot.title = element_text(size = 16, face="italic"),  # Increase title size
    axis.title.x = element_text(size = 15),  # Increase x-axis title size
    axis.title.y = element_text(size = 15),  # Increase y-axis title size
    axis.text.x = element_text(size = 13),  # Increase x-axis text size
    axis.text.y = element_text(size = 13)   # Increase y-axis text size
  )
)

BP.corr.dat <- read.csv("corr.dat/BP.corr.dat_plot.csv")
(plot.BP.corr <- BP.corr.dat %>%
  mutate(indiv = as.factor(indiv)) %>%  # Ensure 'individual' is a factor
  ggplot(aes(x = elapsed/60, y = A, color = indiv, group = indiv)) +  # Add group = individual
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  labs(title = "Betula papyrifera", x = " ", y = "") + 
  theme_minimal() + 
  scale_color_manual(values = c("#D95F02","#D95F02","#D95F02","#D95F02","#D95F02"), name = "") + 
  theme(
    legend.position = "none",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_blank(),
    plot.title = element_text(size = 16, face="italic"),  # Increase title size
    axis.title.x = element_text(size = 15),  # Increase x-axis title size
    axis.title.y = element_text(size = 15),  # Increase y-axis title size
    axis.text.x = element_text(size = 13),  # Increase x-axis text size
    axis.text.y = element_text(size = 13)   # Increase y-axis text size
  )
)

CB.corr.dat <- read.csv("corr.dat/CB.corr.dat_plot.csv")
(plot.CB.corr <- CB.corr.dat %>%
  mutate(indiv = as.factor(indiv)) %>%  # Ensure 'individual' is a factor
  ggplot(aes(x = elapsed/60, y = A, color = indiv, group = indiv)) +  # Add group = individual
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  labs(title = "Carpinus betulus", x = " ", y = expression('Photosynthetic rate (μmol/m'^2*'s'^-1*')')) + 
  theme_minimal() + 
  scale_color_manual(values = c("#7570B3","#7570B3","#7570B3","#7570B3","#7570B3"), name = "") + 
  theme(
    legend.position = "none",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_blank(),
    plot.title = element_text(size = 16, face="italic"),  # Increase title size
    axis.title.x = element_text(size = 15),  # Increase x-axis title size
    axis.title.y = element_text(size = 15),  # Increase y-axis title size
    axis.text.x = element_text(size = 13),  # Increase x-axis text size
    axis.text.y = element_text(size = 13)   # Increase y-axis text size
  )
)

PM.corr.dat <- read.csv("corr.dat/PM.corr.dat_plot.csv")
(plot.PM.corr <- PM.corr.dat %>%
  mutate(indiv = as.factor(indiv)) %>%  # Ensure 'individual' is a factor
  ggplot(aes(x = elapsed/60, y = A, color = indiv, group = indiv)) +  # Add group = individual
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  labs(title = "Pseudotsuga menziesii", x = "Minutes", y = "") + 
  theme_minimal() + 
  scale_color_manual(values = c("#E7298A","#E7298A","#E7298A"), name = "") + 
  theme(
    legend.position = "none",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_blank(),
    plot.title = element_text(size = 16, face="italic"),  # Increase title size
    axis.title.x = element_text(size = 15),  # Increase x-axis title size
    axis.title.y = element_text(size = 15),  # Increase y-axis title size
    axis.text.x = element_text(size = 13),  # Increase x-axis text size
    axis.text.y = element_text(size = 13)   # Increase y-axis text size
  )
)

QG.corr.dat <- read.csv("corr.dat/QG.corr.dat_plot.csv")
(plot.QG.corr <- QG.corr.dat %>%
  mutate(indiv = as.factor(indiv)) %>%  # Ensure 'individual' is a factor
  ggplot(aes(x = elapsed/60, y = A, color = indiv, group = indiv)) +  # Add group = individual
  geom_point() + 
  geom_smooth(method = "lm", se = FALSE) + 
  labs(title = "Quercus garryana", x = "Minutes", y = "") + 
  theme_minimal() + 
  scale_color_manual(values = c("#66A61E","#66A61E","#66A61E","#66A61E","#66A61E"), name = "") + 
  theme(
    legend.position = "none",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black"),
    panel.border = element_blank(),
    plot.title = element_text(size = 16, face="italic"),  # Increase title size
    axis.title.x = element_text(size = 15),  # Increase x-axis title size
    axis.title.y = element_text(size = 15),  # Increase y-axis title size
    axis.text.x = element_text(size = 13),  # Increase x-axis text size
    axis.text.y = element_text(size = 13)   # Increase y-axis text size
  )
)


(corr.plot.all=ggarrange(plot.AC.corr,plot.BP.corr,plot.CB.corr,plot.PM.corr,plot.QG.corr,nrow=3,ncol=2))
```
S4a: Map figure
```{r}
study_data <- read_excel("ExtraFiles/meta.lnRR.LatLong.xlsx")
world_map <- map_data("world")
color_palette <- c(
  "Kar et al. 2021" = "#88CCEE", "Lakso 1982" = "#CC6677", "Meng and Arp 1992" = "#332288",
  "Missik et al. 2021" = "#117733", "Miyazawa et al. 2011" = "#882255", "Santiago and Mulkey 2003" = "#D55E00",
  "This Study" = "#AA4499", "Verryckt et al. 2020" = "#44AA99"
)
(map_S4 <- ggplot() +
  geom_polygon(data = world_map, aes(x = long, y = lat, group = group), fill = "lightgray", color = "white") +
  geom_point(data = study_data, aes(x = longitude, y = latitude, size = species, color = Reference), alpha = 0.7) +
  scale_color_manual(values = color_palette) +  # Use scale_color_manual for the color aesthetic
  scale_size_continuous(range = c(3, 10)) +  # Adjust the range for dot sizes
  theme_classic() +
  labs(x = "Longitude",
       y = "Latitude",
       size = "Species count",
       color = "Reference") +
  theme(axis.title.x = element_text(size = 17),  
        axis.title.y = element_text(size = 17),  
        axis.text.x = element_text(size = 16),  
        axis.text.y = element_text(size = 16),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 16),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.position = "right",panel.border = element_rect(color = "black", fill = NA, size = 1)))
```
S4b: Whittaker figure
```{r}
bioclim_data <- geodata::worldclim_global(var = 'bio', res = 10, path = tempdir())

locations <- study_data %>%
  dplyr::select(latitude, longitude)

locations_vect <- vect(locations, geom = c("longitude", "latitude"), crs = "+proj=longlat +datum=WGS84")
bioclim_values <- extract(bioclim_data, locations_vect)
study_data <- cbind(study_data, bioclim_values)

study_data <- study_data[, !duplicated(names(study_data))]
study_data <- study_data %>%
  rename(temperature = wc2.1_10m_bio_1, precipitation = wc2.1_10m_bio_12)

# Load the Whittaker biome data
Whittaker <- read.csv("ExtraFiles/WhittakerClimateSpace_path.csv", header = TRUE)

# Define coordinates for plotting biome labels (numbers 1-9)
biomes <- data.frame(
  x = c(25.8, 18.7, 28.1, 18.5, 2.2, 28.4, 18, -8.7, 28.4),
  y = c(4150, 2800, 1425, 2100, 1500, 675, 500, 250, 200),
  label = c(1:9)
)


# Create the plot
(Fig_1b <- ggplot(study_data, aes(x = temperature, y = precipitation)) + 
  geom_path(data = Whittaker, aes(x = MAT_whittaker, y = MAP_whittaker)) +
  geom_point(aes(fill = Reference, size = species), shape = 21, alpha = 0.75) +
  scale_fill_manual(values = color_palette) +
  scale_size_continuous(range = c(3, 10)) +  # Adjust the range for dot sizes
  xlab(expression('Mean annual temperature' ~ (degree * C))) + 
  ylab("Mean annual precip. (mm)") + 
  guides(
    fill = guide_legend(override.aes = list(size = 4)),
    size = guide_legend(title = "Species Count")
  ) +
  geom_text(data = biomes, aes(label = label, x = x, y = y), size = 4) + 
  theme_bw(base_size = 13) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        axis.title.x = element_text(size = 17),  
        axis.title.y = element_text(size = 17),  
        axis.text.x = element_text(size = 16),  
        axis.text.y = element_text(size = 16),
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 16),
        legend.position = "right",
        panel.border = element_rect(color = "black", fill = NA, size = 1)))

figS4 = ggarrange(map_S4, Fig_1b, labels=c("F","G"), ncol=2, common.legend = TRUE,legend = "right")
```

Combine meta-analysis figure with map and whittaker figure
```{r}
(figS4 = ggarrange(map_S4, Fig_1b, labels=c("F","G"), nrow=1, common.legend = TRUE,legend = "left"))
fig6 <- ggarrange(multi_panel_plot,figS4, nrow=2,heights = c(2, 1))
ggsave("Fig6.png", plot = fig6, width = 14, height = 15, dpi = 300)
```

